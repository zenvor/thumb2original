<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>thumb2original API å®¢æˆ·ç«¯</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', 'Cantarell', sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
    }

    .header {
      background: white;
      padding: 30px;
      border-radius: 12px;
      margin-bottom: 20px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.1);
    }

    h1 {
      color: #333;
      margin-bottom: 10px;
    }

    .subtitle {
      color: #666;
      font-size: 14px;
    }

    .status {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: bold;
      margin-left: 10px;
    }

    .status.connected {
      background: #10b981;
      color: white;
    }

    .status.disconnected {
      background: #ef4444;
      color: white;
    }

    .grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin-bottom: 20px;
    }

    @media (max-width: 768px) {
      .grid {
        grid-template-columns: 1fr;
      }
    }

    .card {
      background: white;
      padding: 24px;
      border-radius: 12px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.1);
    }

    .card h2 {
      color: #333;
      margin-bottom: 16px;
      font-size: 18px;
    }

    .form-group {
      margin-bottom: 16px;
    }

    label {
      display: block;
      margin-bottom: 6px;
      color: #555;
      font-size: 14px;
      font-weight: 500;
    }

    input, select, textarea {
      width: 100%;
      padding: 10px 12px;
      border: 2px solid #e5e7eb;
      border-radius: 8px;
      font-size: 14px;
      transition: border-color 0.3s;
    }

    input:focus, select:focus, textarea:focus {
      outline: none;
      border-color: #667eea;
    }

    textarea {
      resize: vertical;
      min-height: 80px;
      font-family: monospace;
    }

    button {
      background: #667eea;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      width: 100%;
    }

    button:hover {
      background: #5568d3;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
    }

    button:active {
      transform: translateY(0);
    }

    button:disabled {
      background: #9ca3af;
      cursor: not-allowed;
      transform: none;
    }

    .task-list {
      max-height: 500px;
      overflow-y: auto;
    }

    .task-item {
      background: #f9fafb;
      padding: 16px;
      border-radius: 8px;
      margin-bottom: 12px;
      border-left: 4px solid #667eea;
    }

    .task-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }

    .task-id {
      font-family: monospace;
      font-size: 12px;
      color: #666;
    }

    .task-status {
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: bold;
      text-transform: uppercase;
    }

    .task-status.pending { background: #fbbf24; color: #78350f; }
    .task-status.queued { background: #60a5fa; color: #1e3a8a; }
    .task-status.running { background: #3b82f6; color: white; }
    .task-status.completed { background: #10b981; color: white; }
    .task-status.failed { background: #ef4444; color: white; }
    .task-status.cancelled { background: #6b7280; color: white; }

    .task-info {
      font-size: 13px;
      color: #555;
      margin-bottom: 4px;
    }

    .task-progress {
      background: #e5e7eb;
      height: 6px;
      border-radius: 3px;
      overflow: hidden;
      margin-top: 8px;
    }

    .task-progress-bar {
      background: #667eea;
      height: 100%;
      transition: width 0.3s;
    }

    .task-actions {
      margin-top: 8px;
      display: flex;
      gap: 8px;
    }

    .task-actions button {
      flex: 1;
      padding: 6px 12px;
      font-size: 12px;
    }

    .log {
      background: #1f2937;
      color: #10b981;
      padding: 16px;
      border-radius: 8px;
      font-family: monospace;
      font-size: 12px;
      max-height: 300px;
      overflow-y: auto;
      line-height: 1.6;
    }

    .log-entry {
      margin-bottom: 4px;
    }

    .log-time {
      color: #6b7280;
    }

    .stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
      gap: 12px;
      margin-bottom: 16px;
    }

    .stat-box {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      padding: 16px;
      border-radius: 8px;
      text-align: center;
      color: white;
    }

    .stat-value {
      font-size: 24px;
      font-weight: bold;
      margin-bottom: 4px;
    }

    .stat-label {
      font-size: 11px;
      text-transform: uppercase;
      opacity: 0.9;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>
        thumb2original API å®¢æˆ·ç«¯
        <span class="status" id="wsStatus">æœªè¿æ¥</span>
      </h1>
      <p class="subtitle">å®æ—¶ç›‘æ§å’Œç®¡ç†å›¾ç‰‡çˆ¬è™«ä»»åŠ¡</p>
    </div>

    <div class="grid">
      <div class="card">
        <h2>ğŸ“ åˆ›å»ºæ–°ä»»åŠ¡</h2>
        <form id="taskForm">
          <div class="form-group">
            <label>API åœ°å€</label>
            <input type="text" id="apiUrl" value="http://localhost:3000" placeholder="http://localhost:3000">
          </div>

          <div class="form-group">
            <label>çˆ¬å–æ¨¡å¼</label>
            <select id="scrapeMode">
              <option value="single_page">å•é¡µé¢</option>
              <option value="multiple_pages">å¤šé¡µé¢</option>
              <option value="local_html">æœ¬åœ°HTML</option>
            </select>
          </div>

          <div class="form-group">
            <label>å›¾ç‰‡æ¨¡å¼</label>
            <select id="imageMode">
              <option value="all">æ‰€æœ‰å›¾ç‰‡</option>
              <option value="originals_only">ä»…åŸå›¾</option>
            </select>
          </div>

          <div class="form-group" id="targetUrlGroup">
            <label>ç›®æ ‡ URL</label>
            <input type="text" id="targetUrl" placeholder="https://example.com/gallery">
          </div>

          <div class="form-group" id="targetUrlsGroup" style="display: none;">
            <label>ç›®æ ‡ URLs (æ¯è¡Œä¸€ä¸ª)</label>
            <textarea id="targetUrls" placeholder="https://example.com/page1&#10;https://example.com/page2"></textarea>
          </div>

          <button type="submit">ğŸš€ åˆ›å»ºä»»åŠ¡</button>
        </form>
      </div>

      <div class="card">
        <h2>ğŸ“Š ç³»ç»ŸçŠ¶æ€</h2>
        <div class="stats" id="stats">
          <div class="stat-box">
            <div class="stat-value" id="statTotal">0</div>
            <div class="stat-label">æ€»ä»»åŠ¡</div>
          </div>
          <div class="stat-box">
            <div class="stat-value" id="statRunning">0</div>
            <div class="stat-label">è¿è¡Œä¸­</div>
          </div>
          <div class="stat-box">
            <div class="stat-value" id="statCompleted">0</div>
            <div class="stat-label">å·²å®Œæˆ</div>
          </div>
          <div class="stat-box">
            <div class="stat-value" id="statFailed">0</div>
            <div class="stat-label">å¤±è´¥</div>
          </div>
        </div>
        <button onclick="loadTasks()">ğŸ”„ åˆ·æ–°ä»»åŠ¡åˆ—è¡¨</button>
      </div>
    </div>

    <div class="card">
      <h2>ğŸ“‹ ä»»åŠ¡åˆ—è¡¨</h2>
      <div class="task-list" id="taskList">
        <p style="text-align: center; color: #999; padding: 20px;">æš‚æ— ä»»åŠ¡</p>
      </div>
    </div>

    <div class="card">
      <h2>ğŸ“¡ å®æ—¶æ—¥å¿—</h2>
      <div class="log" id="log"></div>
    </div>
  </div>

  <script src="https://cdn.socket.io/4.6.0/socket.io.min.js"></script>
  <script>
    let socket = null
    let apiUrl = 'http://localhost:3000'

    // åˆå§‹åŒ–
    document.getElementById('scrapeMode').addEventListener('change', function() {
      const mode = this.value
      document.getElementById('targetUrlGroup').style.display = mode === 'single_page' ? 'block' : 'none'
      document.getElementById('targetUrlsGroup').style.display = mode === 'multiple_pages' ? 'block' : 'none'
    })

    // è¿æ¥ WebSocket
    function connectWebSocket() {
      const url = document.getElementById('apiUrl').value
      apiUrl = url

      if (socket) {
        socket.disconnect()
      }

      socket = io(url)

      socket.on('connect', () => {
        addLog('âœ… WebSocket å·²è¿æ¥')
        document.getElementById('wsStatus').textContent = 'å·²è¿æ¥'
        document.getElementById('wsStatus').className = 'status connected'
        socket.emit('subscribe')
      })

      socket.on('disconnect', () => {
        addLog('âŒ WebSocket æ–­å¼€è¿æ¥')
        document.getElementById('wsStatus').textContent = 'æœªè¿æ¥'
        document.getElementById('wsStatus').className = 'status disconnected'
      })

      socket.on('task:created', (data) => {
        addLog(`ğŸ“ ä»»åŠ¡åˆ›å»º: ${data.taskId}`)
        loadTasks()
      })

      socket.on('task:started', (data) => {
        addLog(`â–¶ï¸ ä»»åŠ¡å¼€å§‹: ${data.taskId}`)
        loadTasks()
      })

      socket.on('task:progress', (data) => {
        addLog(`â³ ä»»åŠ¡è¿›åº¦: ${data.taskId} - ${JSON.stringify(data.progress)}`)
        updateTaskProgress(data.taskId, data.progress)
      })

      socket.on('task:completed', (data) => {
        addLog(`âœ… ä»»åŠ¡å®Œæˆ: ${data.taskId}`)
        loadTasks()
      })

      socket.on('task:failed', (data) => {
        addLog(`âŒ ä»»åŠ¡å¤±è´¥: ${data.taskId} - ${data.error}`)
        loadTasks()
      })

      socket.on('task:cancelled', (data) => {
        addLog(`ğŸš« ä»»åŠ¡å–æ¶ˆ: ${data.taskId}`)
        loadTasks()
      })
    }

    // æ·»åŠ æ—¥å¿—
    function addLog(message) {
      const log = document.getElementById('log')
      const time = new Date().toLocaleTimeString()
      const entry = document.createElement('div')
      entry.className = 'log-entry'
      entry.innerHTML = `<span class="log-time">[${time}]</span> ${message}`
      log.appendChild(entry)
      log.scrollTop = log.scrollHeight
    }

    // åˆ›å»ºä»»åŠ¡
    document.getElementById('taskForm').addEventListener('submit', async (e) => {
      e.preventDefault()

      const scrapeMode = document.getElementById('scrapeMode').value
      const imageMode = document.getElementById('imageMode').value
      const targetUrl = document.getElementById('targetUrl').value
      const targetUrls = document.getElementById('targetUrls').value.split('\n').filter(Boolean)

      const config = {
        scrapeMode,
        imageMode
      }

      if (scrapeMode === 'single_page') {
        config.targetUrl = targetUrl
      } else if (scrapeMode === 'multiple_pages') {
        config.targetUrls = targetUrls
      }

      try {
        const response = await fetch(`${apiUrl}/api/tasks`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ config })
        })

        const data = await response.json()
        addLog(`ğŸ‰ ä»»åŠ¡åˆ›å»ºæˆåŠŸ: ${data.taskId}`)
        loadTasks()
      } catch (error) {
        addLog(`âŒ åˆ›å»ºä»»åŠ¡å¤±è´¥: ${error.message}`)
      }
    })

    // åŠ è½½ä»»åŠ¡åˆ—è¡¨
    async function loadTasks() {
      try {
        const response = await fetch(`${apiUrl}/api/tasks`)
        const data = await response.json()

        // æ›´æ–°ç»Ÿè®¡
        const stats = data.stats || {}
        document.getElementById('statTotal').textContent = stats.total || 0
        document.getElementById('statRunning').textContent = stats.running || 0
        document.getElementById('statCompleted').textContent = stats.completed || 0
        document.getElementById('statFailed').textContent = stats.failed || 0

        // æ›´æ–°ä»»åŠ¡åˆ—è¡¨
        const taskList = document.getElementById('taskList')
        if (data.tasks.length === 0) {
          taskList.innerHTML = '<p style="text-align: center; color: #999; padding: 20px;">æš‚æ— ä»»åŠ¡</p>'
          return
        }

        taskList.innerHTML = data.tasks.map(task => `
          <div class="task-item" id="task-${task.id}">
            <div class="task-header">
              <span class="task-id">${task.id}</span>
              <span class="task-status ${task.status}">${task.status}</span>
            </div>
            <div class="task-info">
              <strong>æ¨¡å¼:</strong> ${task.config.scrapeMode} |
              <strong>å›¾ç‰‡:</strong> ${task.config.imageMode}
            </div>
            ${task.config.targetUrl ? `<div class="task-info"><strong>URL:</strong> ${task.config.targetUrl}</div>` : ''}
            ${task.status === 'running' && task.progress ? `
              <div class="task-progress">
                <div class="task-progress-bar" style="width: ${calculateProgress(task)}%"></div>
              </div>
            ` : ''}
            <div class="task-actions">
              ${task.status === 'running' ? `
                <button onclick="cancelTask('${task.id}')">âŒ å–æ¶ˆ</button>
              ` : ''}
              ${task.status === 'completed' || task.status === 'failed' || task.status === 'cancelled' ? `
                <button onclick="deleteTask('${task.id}')">ğŸ—‘ï¸ åˆ é™¤</button>
              ` : ''}
            </div>
          </div>
        `).join('')
      } catch (error) {
        addLog(`âŒ åŠ è½½ä»»åŠ¡å¤±è´¥: ${error.message}`)
      }
    }

    // è®¡ç®—è¿›åº¦
    function calculateProgress(task) {
      if (!task.progress) return 0
      if (task.progress.totalUrls) {
        return Math.round((task.progress.urlIndex / task.progress.totalUrls) * 100)
      }
      return 50
    }

    // æ›´æ–°ä»»åŠ¡è¿›åº¦
    function updateTaskProgress(taskId, progress) {
      const taskElement = document.getElementById(`task-${taskId}`)
      if (!taskElement) return

      // è¿™é‡Œå¯ä»¥å®æ—¶æ›´æ–°è¿›åº¦æ¡ï¼Œä½†ä¸ºäº†ç®€åŒ–ï¼Œæˆ‘ä»¬åªåœ¨ loadTasks æ—¶æ›´æ–°
    }

    // å–æ¶ˆä»»åŠ¡
    async function cancelTask(taskId) {
      try {
        await fetch(`${apiUrl}/api/tasks/${taskId}/cancel`, { method: 'POST' })
        addLog(`ğŸš« ä»»åŠ¡å·²å–æ¶ˆ: ${taskId}`)
        loadTasks()
      } catch (error) {
        addLog(`âŒ å–æ¶ˆä»»åŠ¡å¤±è´¥: ${error.message}`)
      }
    }

    // åˆ é™¤ä»»åŠ¡
    async function deleteTask(taskId) {
      try {
        await fetch(`${apiUrl}/api/tasks/${taskId}`, { method: 'DELETE' })
        addLog(`ğŸ—‘ï¸ ä»»åŠ¡å·²åˆ é™¤: ${taskId}`)
        loadTasks()
      } catch (error) {
        addLog(`âŒ åˆ é™¤ä»»åŠ¡å¤±è´¥: ${error.message}`)
      }
    }

    // é¡µé¢åŠ è½½æ—¶è¿æ¥
    window.addEventListener('load', () => {
      connectWebSocket()
      loadTasks()
      setInterval(loadTasks, 5000) // æ¯ 5 ç§’åˆ·æ–°ä¸€æ¬¡
    })
  </script>
</body>
</html>
