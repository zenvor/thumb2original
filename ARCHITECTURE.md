# ğŸ›ï¸ æ¶æ„è®¾è®¡æ–‡æ¡£

## ğŸ“‹ ç›®å½•

1. [ç³»ç»Ÿæ¶æ„](#ç³»ç»Ÿæ¶æ„)
2. [æ ¸å¿ƒæ¨¡å—](#æ ¸å¿ƒæ¨¡å—)
3. [æ•°æ®æµ](#æ•°æ®æµ)
4. [è®¾è®¡å†³ç­–](#è®¾è®¡å†³ç­–)
5. [æ‰©å±•æ€§](#æ‰©å±•æ€§)

---

## ğŸ¯ ç³»ç»Ÿæ¶æ„

### æ•´ä½“æ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        ç”¨æˆ·å±‚                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚   CLI å·¥å…·  â”‚              Web å®¢æˆ·ç«¯                        â”‚
â”‚  (cli.js)   â”‚         (æµè§ˆå™¨/HTTPå®¢æˆ·ç«¯)                    â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚                       â”‚
       â”‚                       â†“
       â”‚              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
       â”‚              â”‚  HTTP Server    â”‚
       â”‚              â”‚  (Express)      â”‚
       â”‚              â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚                       â”‚
       â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
               â†“               â†“
       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
       â”‚ScraperEngine â”‚  â”‚TaskManager  â”‚
       â”‚ (æ ¸å¿ƒå¼•æ“)   â”‚  â”‚ (ä»»åŠ¡é˜Ÿåˆ—)  â”‚
       â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
              â”‚                 â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â†“
       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
       â”‚       ä¸šåŠ¡é€»è¾‘å±‚ (lib/)         â”‚
       â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
       â”‚ â€¢ Browser Launcher (æµè§ˆå™¨)     â”‚
       â”‚ â€¢ Page Loader (é¡µé¢åŠ è½½)        â”‚
       â”‚ â€¢ Image Extractor (å›¾ç‰‡æå–)    â”‚
       â”‚ â€¢ Image Fetcher (å›¾ç‰‡è·å–)      â”‚
       â”‚ â€¢ Image Analyzer (å›¾ç‰‡åˆ†æ)     â”‚
       â”‚ â€¢ Download Queue (ä¸‹è½½é˜Ÿåˆ—)     â”‚
       â”‚ â€¢ File Manager (æ–‡ä»¶ç®¡ç†)       â”‚
       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â†“
       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
       â”‚      å·¥å…·å±‚ (utils/)            â”‚
       â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
       â”‚ â€¢ Logger (æ—¥å¿—)                 â”‚
       â”‚ â€¢ Errors (é”™è¯¯å¤„ç†)             â”‚
       â”‚ â€¢ Image Utils (å›¾ç‰‡å·¥å…·)        â”‚
       â”‚ â€¢ File Utils (æ–‡ä»¶å·¥å…·)         â”‚
       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ§© æ ¸å¿ƒæ¨¡å—

### 1. ScraperEngine (lib/core/ScraperEngine.js)

**èŒè´£**: çˆ¬è™«æ ¸å¿ƒå¼•æ“ï¼Œå°è£…å®Œæ•´çš„çˆ¬å–ç”Ÿå‘½å‘¨æœŸ

**å…³é”®ç‰¹æ€§**:
- çŠ¶æ€ç®¡ç†ï¼ˆidle â†’ running â†’ completed/failedï¼‰
- äº‹ä»¶é©±åŠ¨ï¼ˆprogress, complete, error, statusChangeï¼‰
- èµ„æºç®¡ç†ï¼ˆæµè§ˆå™¨ç”Ÿå‘½å‘¨æœŸï¼‰
- é”™è¯¯æ¢å¤

**çŠ¶æ€æœº**:
```
     idle
      â†“
  initializing
      â†“
    running â”€â”€â†’ failed
      â†“
  completed
```

**å…¬å…±æ¥å£**:
```javascript
class ScraperEngine {
  constructor(config, options)
  async run()                    // è¿è¡Œçˆ¬è™«
  async cancel()                 // å–æ¶ˆè¿è¡Œ
  getStatus()                    // è·å–çŠ¶æ€å¿«ç…§
  updateStatus(status, data)     // æ›´æ–°çŠ¶æ€
  emitProgress(data)             // å‘é€è¿›åº¦
}
```

### 2. TaskManager (server/TaskManager.js)

**èŒè´£**: ä»»åŠ¡é˜Ÿåˆ—ç®¡ç†å’Œå¹¶å‘æ§åˆ¶

**å…³é”®ç‰¹æ€§**:
- ä»»åŠ¡ç”Ÿå‘½å‘¨æœŸç®¡ç†
- å¹¶å‘æ•°æ§åˆ¶
- é˜Ÿåˆ—è°ƒåº¦
- äº‹ä»¶å¹¿æ’­

**ä»»åŠ¡çŠ¶æ€**:
```
pending â†’ queued â†’ running â†’ completed/failed/cancelled
```

**å…¬å…±æ¥å£**:
```javascript
class TaskManager extends EventEmitter {
  createTask(config, options)    // åˆ›å»ºä»»åŠ¡
  async runTask(taskId)          // è¿è¡Œä»»åŠ¡
  getTask(taskId)                // è·å–ä»»åŠ¡çŠ¶æ€
  getAllTasks()                  // è·å–æ‰€æœ‰ä»»åŠ¡
  async cancelTask(taskId)       // å–æ¶ˆä»»åŠ¡
  deleteTask(taskId)             // åˆ é™¤ä»»åŠ¡
  cleanupCompletedTasks(ms)      // æ¸…ç†å·²å®Œæˆä»»åŠ¡
  getStats()                     // ç»Ÿè®¡ä¿¡æ¯
}
```

### 3. ScraperServer (server/index.js)

**èŒè´£**: HTTP API æœåŠ¡å™¨å’Œ WebSocket æœåŠ¡

**å…³é”®ç‰¹æ€§**:
- RESTful API è·¯ç”±
- WebSocket å®æ—¶é€šè®¯
- CORS æ”¯æŒ
- é”™è¯¯å¤„ç†ä¸­é—´ä»¶

**API ç«¯ç‚¹**:
```
GET    /health                    # å¥åº·æ£€æŸ¥
POST   /api/tasks                 # åˆ›å»ºä»»åŠ¡
GET    /api/tasks                 # è·å–æ‰€æœ‰ä»»åŠ¡
GET    /api/tasks/:taskId         # è·å–ä»»åŠ¡çŠ¶æ€
POST   /api/tasks/:taskId/cancel  # å–æ¶ˆä»»åŠ¡
DELETE /api/tasks/:taskId         # åˆ é™¤ä»»åŠ¡
POST   /api/tasks/cleanup         # æ¸…ç†å·²å®Œæˆä»»åŠ¡
GET    /api/docs                  # API æ–‡æ¡£
```

**WebSocket äº‹ä»¶**:
```
task:created      # ä»»åŠ¡åˆ›å»º
task:queued       # ä»»åŠ¡è¿›å…¥é˜Ÿåˆ—
task:started      # ä»»åŠ¡å¼€å§‹
task:progress     # ä»»åŠ¡è¿›åº¦
task:status       # çŠ¶æ€å˜åŒ–
task:completed    # ä»»åŠ¡å®Œæˆ
task:failed       # ä»»åŠ¡å¤±è´¥
task:cancelled    # ä»»åŠ¡å–æ¶ˆ
task:deleted      # ä»»åŠ¡åˆ é™¤
```

### 4. ä¸šåŠ¡é€»è¾‘å±‚ (lib/)

#### Browser Launcher
```javascript
// lib/browserLauncher.js
export async function launchBrowser(config)
```
- å¯åŠ¨ Puppeteer æµè§ˆå™¨
- åº”ç”¨åæ£€æµ‹é…ç½®
- è¿æ¥ç›‘æ§

#### Page Loader
```javascript
// lib/pageLoader.js
export async function loadAndScrollPage(page, url, config)
```
- é¡µé¢åŠ è½½å’Œå¯¼èˆª
- æ»šåŠ¨åŠ è½½
- ç­‰å¾…ç­–ç•¥

#### Image Extractor
```javascript
// lib/imageExtractor.js
export async function extractImageUrls(page, url, options)
```
- ä»é¡µé¢æå–å›¾ç‰‡ URL
- æ”¯æŒå¤šç§å›¾ç‰‡æ¥æºï¼ˆimg, srcset, CSS ç­‰ï¼‰
- URL å»é‡å’ŒéªŒè¯

#### Image Mode Processor
```javascript
// lib/imageModeProcessor.js
export async function processUrlsByImageMode(page, urls, baseUrl, mode, config)
```
- ç¼©ç•¥å›¾è½¬åŸå›¾
- å›¾ç‰‡ URL è½¬æ¢è§„åˆ™
- ç«™ç‚¹ç‰¹å®šå¤„ç†

#### Download Queue
```javascript
// lib/downloadQueue.js
export async function processDownloadQueue(urls, targetDir, context, imageList)
```
- å¹¶å‘ä¸‹è½½æ§åˆ¶
- é‡è¯•æœºåˆ¶
- è¿›åº¦è·Ÿè¸ª
- ä¸¤é˜¶æ®µå¤„ç†ï¼ˆtwoPhase modeï¼‰

#### Image Fetcher
```javascript
// lib/imageFetcher.js
export async function fetchImage(url, browser, maxRetries, config)
```
- å›¾ç‰‡ä¸‹è½½ï¼ˆAxios/Puppeteer åŒç­–ç•¥ï¼‰
- å†…å®¹ç±»å‹éªŒè¯
- é”™è¯¯å¤„ç†

#### Image Analyzer
```javascript
// lib/imageAnalyzer.js
export async function analyzeImage(buffer, url, config)
```
- å›¾ç‰‡æ ¼å¼è¯†åˆ«
- å°ºå¯¸æå–
- å…ƒæ•°æ®è§£æ
- éªŒè¯è§„åˆ™

#### File Manager
```javascript
// lib/fileManager.js
export async function saveImage(buffer, filePath, url, stats, imageList, config, analysisResult)
export async function createDownloadDirectory(baseDir, title)
```
- æ–‡ä»¶ä¿å­˜
- æ ¼å¼è½¬æ¢
- ç›®å½•ç®¡ç†
- æ–‡ä»¶åç”Ÿæˆå’Œå»é‡

---

## ğŸ”„ æ•°æ®æµ

### CLI æ¨¡å¼æ•°æ®æµ

```
1. ç”¨æˆ·é…ç½® (config/config.js)
   â†“
2. cli.js åˆå§‹åŒ–
   â†“
3. åˆ›å»º ScraperEngine
   â†“
4. engine.run()
   â”œâ”€â†’ éªŒè¯é…ç½®
   â”œâ”€â†’ å¯åŠ¨æµè§ˆå™¨
   â”œâ”€â†’ åŠ è½½é¡µé¢
   â”œâ”€â†’ æå–å›¾ç‰‡ URL
   â”œâ”€â†’ å¤„ç†å›¾ç‰‡æ¨¡å¼
   â”œâ”€â†’ ä¸‹è½½é˜Ÿåˆ—å¤„ç†
   â”‚   â”œâ”€â†’ å¹¶å‘è·å–å›¾ç‰‡
   â”‚   â”œâ”€â†’ åˆ†æå›¾ç‰‡
   â”‚   â””â”€â†’ ä¿å­˜æ–‡ä»¶
   â””â”€â†’ æ¸…ç†èµ„æº
   â†“
5. è¾“å‡ºç»“æœåˆ°æ§åˆ¶å°
```

### API æ¨¡å¼æ•°æ®æµ

```
1. HTTP è¯·æ±‚ (POST /api/tasks)
   â†“
2. ScraperServer æ¥æ”¶è¯·æ±‚
   â†“
3. TaskManager.createTask(config)
   â†“
4. TaskManager.runTask(taskId)
   â”œâ”€â†’ æ£€æŸ¥å¹¶å‘æ•°
   â”œâ”€â†’ å¦‚è¶…å‡º â†’ è¿›å…¥é˜Ÿåˆ—
   â””â”€â†’ å¦åˆ™ â†’ åˆ›å»º ScraperEngine
   â†“
5. engine.run()
   â”œâ”€â†’ (åŒ CLI æ¨¡å¼)
   â”œâ”€â†’ æ¯ä¸ªæ­¥éª¤è§¦å‘äº‹ä»¶
   â”‚   â”œâ”€â†’ task:progress
   â”‚   â”œâ”€â†’ task:status
   â”‚   â””â”€â†’ task:completed/failed
   â””â”€â†’ äº‹ä»¶é€šè¿‡ WebSocket æ¨é€
   â†“
6. è¿”å›ä»»åŠ¡çŠ¶æ€ (HTTP å“åº”)
```

### äº‹ä»¶æµ

```
TaskManager Events:
  task:created â”€â”€â”
  task:started â”€â”€â”¤
  task:progress â”€â”¼â”€â†’ ScraperServer â”€â”€â†’ Socket.IO â”€â”€â†’ Web å®¢æˆ·ç«¯
  task:completedâ”€â”¤
  task:failed â”€â”€â”€â”˜

ScraperEngine Callbacks:
  onProgress â”€â”€â”€â”€â†’ TaskManager â”€â”€â†’ emit('task:progress')
  onComplete â”€â”€â”€â”€â†’ TaskManager â”€â”€â†’ emit('task:completed')
  onError â”€â”€â”€â”€â”€â”€â”€â†’ TaskManager â”€â”€â†’ emit('task:failed')
  onStatusChange â”€â†’ TaskManager â”€â”€â†’ emit('task:status')
```

---

## ğŸ¨ è®¾è®¡å†³ç­–

### 1. ä¸ºä»€ä¹ˆåˆ†ç¦» ScraperEngineï¼Ÿ

**å†³ç­–**: å°†æ ¸å¿ƒçˆ¬è™«é€»è¾‘æŠ½è±¡ä¸ºç‹¬ç«‹çš„ `ScraperEngine` ç±»

**åŸå› **:
- âœ… **å¤ç”¨æ€§**: CLI å’Œ API æ¨¡å¼å…±äº«ç›¸åŒé€»è¾‘
- âœ… **å¯æµ‹è¯•æ€§**: ä¾¿äºå•å…ƒæµ‹è¯•å’Œé›†æˆæµ‹è¯•
- âœ… **å¯ç»´æŠ¤æ€§**: å•ä¸€èŒè´£ï¼Œé€»è¾‘æ¸…æ™°
- âœ… **æ‰©å±•æ€§**: å¯ä»¥è½»æ¾æ·»åŠ æ–°çš„è¿è¡Œæ¨¡å¼ï¼ˆå¦‚ GUIï¼‰

### 2. ä¸ºä»€ä¹ˆä½¿ç”¨ EventEmitterï¼Ÿ

**å†³ç­–**: TaskManager ç»§æ‰¿ EventEmitter

**åŸå› **:
- âœ… **è§£è€¦**: ä»»åŠ¡æ‰§è¡Œå’ŒçŠ¶æ€é€šçŸ¥è§£è€¦
- âœ… **å®æ—¶æ€§**: æ”¯æŒå®æ—¶è¿›åº¦æ¨é€
- âœ… **çµæ´»æ€§**: è®¢é˜…è€…å¯ä»¥é€‰æ‹©ç›‘å¬å“ªäº›äº‹ä»¶
- âœ… **Node.js åŸç”Ÿ**: æ— éœ€é¢å¤–ä¾èµ–

### 3. ä¸ºä»€ä¹ˆé€‰æ‹© Expressï¼Ÿ

**å†³ç­–**: ä½¿ç”¨ Express ä½œä¸º HTTP æ¡†æ¶

**åŸå› **:
- âœ… **æˆç†Ÿç¨³å®š**: ä¸šç•Œæ ‡å‡†ï¼Œç¤¾åŒºæ”¯æŒå¥½
- âœ… **ä¸­é—´ä»¶ç”Ÿæ€**: ä¸°å¯Œçš„æ’ä»¶ï¼ˆCORS, body-parser ç­‰ï¼‰
- âœ… **ç®€å•æ˜“ç”¨**: å­¦ä¹ æ›²çº¿å¹³ç¼“
- âœ… **æ€§èƒ½è¶³å¤Ÿ**: å¯¹äºæ­¤åœºæ™¯æ€§èƒ½å·²è¶³å¤Ÿ

**å¤‡é€‰æ–¹æ¡ˆ**:
- Fastifyï¼ˆæ›´é«˜æ€§èƒ½ï¼Œä½†ç”Ÿæ€è¾ƒå°ï¼‰
- Koaï¼ˆæ›´ç°ä»£ï¼Œä½†éœ€è¦æ›´å¤šé…ç½®ï¼‰

### 4. ä¸ºä»€ä¹ˆä½¿ç”¨ Socket.IOï¼Ÿ

**å†³ç­–**: ä½¿ç”¨ Socket.IO å®ç° WebSocket

**åŸå› **:
- âœ… **å…¼å®¹æ€§**: è‡ªåŠ¨é™çº§åˆ°è½®è¯¢
- âœ… **æˆ¿é—´/å‘½åç©ºé—´**: ä¾¿äºå®ç°è®¢é˜…æœºåˆ¶
- âœ… **é‡è¿æœºåˆ¶**: è‡ªåŠ¨å¤„ç†æ–­çº¿é‡è¿
- âœ… **åŒå‘é€šä¿¡**: æ”¯æŒå®¢æˆ·ç«¯ä¸»åŠ¨è®¢é˜…

### 5. ä»»åŠ¡çŠ¶æ€ä¸ºä»€ä¹ˆå­˜åœ¨å†…å­˜ä¸­ï¼Ÿ

**å†³ç­–**: å½“å‰ç‰ˆæœ¬ä»»åŠ¡çŠ¶æ€å­˜å‚¨åœ¨å†…å­˜ï¼ˆMapï¼‰

**åŸå› **:
- âœ… **ç®€å•**: æ— éœ€é¢å¤–çš„æ•°æ®åº“ä¾èµ–
- âœ… **å¿«é€Ÿ**: è¯»å†™æ€§èƒ½æœ€ä½³
- âœ… **é€‚ç”¨åœºæ™¯**: å¯¹äºå•æœºéƒ¨ç½²è¶³å¤Ÿ

**åç»­æ‰©å±•**:
```javascript
// å¯é€‰ï¼šæ·»åŠ  Redis æŒä¹…åŒ–
class PersistentTaskManager extends TaskManager {
  constructor(options) {
    super(options)
    this.redis = new Redis(options.redisUrl)
  }

  async createTask(config) {
    const taskId = super.createTask(config)
    await this.redis.set(`task:${taskId}`, JSON.stringify(this.getTask(taskId)))
    return taskId
  }

  async getTask(taskId) {
    const cached = await this.redis.get(`task:${taskId}`)
    if (cached) return JSON.parse(cached)
    return super.getTask(taskId)
  }
}
```

### 6. ä¸ºä»€ä¹ˆä¿ç•™ index.jsï¼Ÿ

**å†³ç­–**: ä¿æŒ `index.js` ä¸å˜ï¼Œæ–°å¢ `cli.js`

**åŸå› **:
- âœ… **å‘åå…¼å®¹**: ä¸ç ´åç°æœ‰ç”¨æˆ·çš„ä½¿ç”¨æ–¹å¼
- âœ… **æ¸è¿›å¼è¿ç§»**: ç”¨æˆ·å¯ä»¥é€‰æ‹©ä½•æ—¶è¿ç§»
- âœ… **æ–‡æ¡£æ¸…æ™°**: æ–°ç”¨æˆ·ä½¿ç”¨ `cli.js`ï¼Œè€ç”¨æˆ·ç»§ç»­ä½¿ç”¨ `index.js`

---

## ğŸš€ æ‰©å±•æ€§

### 1. æ·»åŠ æ–°çš„å­˜å‚¨åç«¯

```javascript
// lib/storage/StorageAdapter.js
export class StorageAdapter {
  async save(key, value) { throw new Error('Not implemented') }
  async load(key) { throw new Error('Not implemented') }
  async delete(key) { throw new Error('Not implemented') }
}

// lib/storage/RedisAdapter.js
export class RedisAdapter extends StorageAdapter {
  constructor(redisUrl) {
    super()
    this.redis = new Redis(redisUrl)
  }

  async save(key, value) {
    await this.redis.set(key, JSON.stringify(value))
  }

  async load(key) {
    const data = await this.redis.get(key)
    return data ? JSON.parse(data) : null
  }
}

// ä½¿ç”¨
const taskManager = new TaskManager({
  storage: new RedisAdapter('redis://localhost')
})
```

### 2. æ·»åŠ è®¤è¯ä¸­é—´ä»¶

```javascript
// server/middleware/auth.js
export function authMiddleware(options) {
  return (req, res, next) => {
    const token = req.headers.authorization?.replace('Bearer ', '')

    if (!token || !validateToken(token)) {
      return res.status(401).json({ error: 'Unauthorized' })
    }

    req.user = decodeToken(token)
    next()
  }
}

// åœ¨ server/index.js ä¸­ä½¿ç”¨
import { authMiddleware } from './middleware/auth.js'

setupRoutes() {
  this.app.use('/api', authMiddleware({ secret: process.env.JWT_SECRET }))
  // ... å…¶ä»–è·¯ç”±
}
```

### 3. æ·»åŠ é€Ÿç‡é™åˆ¶

```javascript
import rateLimit from 'express-rate-limit'

const limiter = rateLimit({
  windowMs: 15 * 60 * 1000, // 15 åˆ†é’Ÿ
  max: 100 // é™åˆ¶ 100 ä¸ªè¯·æ±‚
})

this.app.use('/api', limiter)
```

### 4. æ·»åŠ è‡ªå®šä¹‰çˆ¬è™«ç­–ç•¥

```javascript
// lib/strategies/CustomStrategy.js
export class CustomStrategy {
  async extract(page, url, config) {
    // è‡ªå®šä¹‰æå–é€»è¾‘
  }
}

// åœ¨ ScraperEngine ä¸­æ³¨å†Œ
engine.registerStrategy('custom', new CustomStrategy())
```

### 5. æ·»åŠ  GraphQL API

```javascript
import { ApolloServer } from '@apollo/server'
import { expressMiddleware } from '@apollo/server/express4'

const typeDefs = `
  type Task {
    id: ID!
    status: String!
    progress: JSON
  }

  type Query {
    task(id: ID!): Task
    tasks: [Task!]!
  }

  type Mutation {
    createTask(config: JSON!): Task!
    cancelTask(id: ID!): Task!
  }
`

const resolvers = {
  Query: {
    task: (_, { id }) => taskManager.getTask(id),
    tasks: () => taskManager.getAllTasks()
  },
  Mutation: {
    createTask: (_, { config }) => {
      const taskId = taskManager.createTask(config)
      taskManager.runTask(taskId)
      return taskManager.getTask(taskId)
    },
    cancelTask: async (_, { id }) => {
      await taskManager.cancelTask(id)
      return taskManager.getTask(id)
    }
  }
}

const apolloServer = new ApolloServer({ typeDefs, resolvers })
await apolloServer.start()

this.app.use('/graphql', expressMiddleware(apolloServer))
```

### 6. é›†æˆæ¶ˆæ¯é˜Ÿåˆ—

```javascript
import Bull from 'bull'

class QueuedTaskManager extends TaskManager {
  constructor(options) {
    super(options)
    this.queue = new Bull('scraper-tasks', options.redisUrl)

    this.queue.process(async (job) => {
      const { config } = job.data
      const engine = new ScraperEngine(config)
      return await engine.run()
    })
  }

  async runTask(taskId) {
    const task = this.getTask(taskId)
    await this.queue.add({ config: task.config })
  }
}
```

---

## ğŸ“Š æ€§èƒ½è€ƒè™‘

### 1. å¹¶å‘æ§åˆ¶

```javascript
// æ ¹æ® CPU æ ¸å¿ƒæ•°åŠ¨æ€è°ƒæ•´
import os from 'os'

const maxConcurrent = Math.max(1, os.cpus().length - 1)
const taskManager = new TaskManager({ maxConcurrent })
```

### 2. å†…å­˜ç®¡ç†

```javascript
// å®šæœŸæ¸…ç†å·²å®Œæˆä»»åŠ¡
setInterval(() => {
  const deleted = taskManager.cleanupCompletedTasks(3600000) // 1å°æ—¶
  if (deleted > 0) {
    logger.info(`æ¸…ç†äº† ${deleted} ä¸ªå·²å®Œæˆä»»åŠ¡`)
  }
}, 600000) // æ¯10åˆ†é’Ÿ
```

### 3. èµ„æºé™åˆ¶

```javascript
// é™åˆ¶ä»»åŠ¡é˜Ÿåˆ—å¤§å°
class LimitedTaskManager extends TaskManager {
  createTask(config, options) {
    if (this.tasks.size >= this.maxTasks) {
      throw new Error('ä»»åŠ¡é˜Ÿåˆ—å·²æ»¡')
    }
    return super.createTask(config, options)
  }
}
```

---

## ğŸ”’ å®‰å…¨è€ƒè™‘

### 1. è¾“å…¥éªŒè¯

```javascript
import Joi from 'joi'

const configSchema = Joi.object({
  scrapeMode: Joi.string().valid('single_page', 'multiple_pages', 'local_html').required(),
  targetUrl: Joi.string().uri().when('scrapeMode', {
    is: 'single_page',
    then: Joi.required()
  }),
  imageMode: Joi.string().valid('all', 'originals_only').required()
})

// åœ¨ API ä¸­ä½¿ç”¨
app.post('/api/tasks', async (req, res) => {
  const { error, value } = configSchema.validate(req.body.config)
  if (error) {
    return res.status(400).json({ error: error.message })
  }
  // ... åˆ›å»ºä»»åŠ¡
})
```

### 2. CSRF ä¿æŠ¤

```javascript
import csrf from 'csurf'

const csrfProtection = csrf({ cookie: true })
this.app.use(csrfProtection)
```

### 3. HTTPS å¼ºåˆ¶

```javascript
this.app.use((req, res, next) => {
  if (!req.secure && process.env.NODE_ENV === 'production') {
    return res.redirect('https://' + req.headers.host + req.url)
  }
  next()
})
```

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [API ä½¿ç”¨æŒ‡å—](./API_GUIDE.md)
- [è¿ç§»æŒ‡å—](./MIGRATION_GUIDE.md)
- [æµ‹è¯•æŒ‡å—](./tests/TESTING_GUIDE.md)
