# 代码复杂度优化任务清单

基于复杂度检查工具 [`code-complexity-check-prompt.md`](./code-complexity-check-prompt.md) 的分析结果，按优先级跟踪需要优化的文件。

> 💡 **经验教训**：简化实现通常能带来显著功能改进（如 CSS 提取：复杂实现 3 个 → 简单实现 164 个结果）

## 🚨 高优先级（急需优化）

### 1. imageAnalyzer.js - **复杂度 8/10**
- **状态**: ❌ 待优化
- **主要问题**:
  - `analyzeImage()` 函数长达 148 行（超标准 5 倍）
  - 多重嵌套条件逻辑（content-type 检查）
  - 8+ 个错误处理分支复杂

- **优化方案**:
  - [ ] 拆分为 `validateImageData()` - 基础验证
  - [ ] 拆分为 `checkContentType()` - 内容类型检查  
  - [ ] 拆分为 `extractMetadata()` - 元数据解析
  - [ ] 拆分为 `validateDimensions()` - 尺寸验证
  - [ ] 提取 `classifyAnalysisError()` - 错误分类

- **预期收益**: 分析准确率提升，维护成本降低

### 2. fileManager.js - **复杂度 7/10**
- **状态**: ❌ 待优化  
- **主要问题**:
  - `saveImage()` 函数 97 行（超标准 3 倍）
  - 7 个参数超过 4 个标准
  - 格式转换逻辑复杂嵌套

- **优化方案**:
  - [ ] 使用选项对象模式减少参数数量
  - [ ] 拆分为 `processFormatConversion()` - 格式转换
  - [ ] 拆分为 `writeImageFile()` - 文件写入
  - [ ] 拆分为 `updateStatistics()` - 统计更新
  - [ ] 拆分为 `collectImageInfo()` - 信息收集

- **预期收益**: 保存失败率降低，代码可测试性提高

## 🟡 中优先级（需要检查）

### 3. downloadQueue.js - **待分析**
- **状态**: 🔍 检查中
- **文件特征**: 24KB 大文件，可能存在复杂度问题
- **检查项目**:
  - [ ] 函数长度检查
  - [ ] 并发控制逻辑复杂度
  - [ ] 重试机制实现
  - [ ] 错误处理分支数量

### 4. imageFetcher.js - **复杂度 6/10**  
- **状态**: ⚠️ 中等复杂
- **主要问题**:
  - `fetchImage()` 函数 51 行（超标准 70%）
  - data URI 解析逻辑嵌入主函数
  - context 参数复杂

- **优化方案**:
  - [ ] 提取 `parseDataUri()` 函数
  - [ ] 简化策略执行逻辑
  - [ ] 明确参数接口定义

## ✅ 已完成

### imageExtractor.js - **已优化** ✅
- **原复杂度**: 7/10 → **优化后**: 3/10
- **优化成果**:
  - ✅ 主函数从 226 行拆分为 6 个专职函数
  - ✅ `extractUrlFromCss` 从 42 行 8+ 分支简化为 20 行统一策略
  - ✅ 正则表达式简化：45 字符复杂正则 → 字符串操作
  - ✅ 修复浏览器作用域错误

## 🟢 低优先级（后续检查）

### 处理器模块
- [ ] `imageModeProcessor.js` - 处理器逻辑
- [ ] `localHtmlProcessor.js` - HTML 处理器

## 📊 总体进度

- **已检查文件**: 6/8 (75%)
- **已优化文件**: 1/8 (12.5%)  
- **高优先级待优化**: 2 个
- **预计优化收益**: 显著提升图片处理成功率

## 🔧 优化工具与原则

### 使用工具
- 复杂度检查模板: [`code-complexity-check-prompt.md`](./code-complexity-check-prompt.md)
- 设计原则指导: [`design-principles.md`](./rules/design-principles.md)

### 核心原则
1. **KISS 原则**: 简单直接 > 复杂抽象
2. **统一错误处理**: 一致的捕获和处理机制
3. **单一职责**: 每个函数 ≤ 30 行，职责明确
4. **防御性编程**: 充分边界检查和错误处理

### 复杂度标准
- **函数长度**: > 30 行标记为复杂
- **参数数量**: > 4 个标记为复杂
- **嵌套深度**: > 3 层标记为复杂
- **条件分支**: > 5 个 if/else 标记为复杂

---

*最后更新: 2025-08-16*
